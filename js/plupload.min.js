/**
 * Plupload - multi-runtime File Uploader
 * v2.1.2
 *
 * Copyright 2013, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Date: 2014-05-14
 */
;(function(e,t,n){function s(e){function r(e,t,r){var i={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};i[e]?n[i[e]]=t:r||(n[e]=t)}var t=e.required_features,n={};if(typeof t=="string")a.each(t.split(/\s*,\s*/),function(e){r(e,!0)});else if(typeof t=="object")a.each(t,function(e,t){r(t,e)});else if(t===!0){e.chunk_size&&e.chunk_size>0&&(n.slice_blob=!0);if(!a.isEmptyObj(e.resize)||e.multipart===!1)n.send_binary_string=!0;e.http_method&&(n.use_http_method=e.http_method),a.each(e,function(e,t){r(t,!!e,!0)})}return n}function o(e,n,r){switch(e){case"chunk_size":if(n=a.parseSize(n))r.send_file_name=!0;break;case"headers":var i={};return typeof n=="object"&&a.each(n,function(e,t){i[t.toLowerCase()]=e}),i;case"http_method":return n.toUpperCase()==="PUT"?"PUT":"POST";case"filters":return a.typeOf(n)==="array"&&(n={mime_types:n}),n.mime_types&&(a.typeOf(n.mime_types)==="string"&&(n.mime_types=t.Mime.mimes2extList(n.mime_types)),n.mime_types.regexp=function(e){var t=[];return a.each(e,function(e){a.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?t.push("\\.*"):t.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),new RegExp("("+t.join("|")+")$","i")}(n.mime_types)),n;case"max_file_size":r&&!r.filters&&(r.filters={}),r.filters.max_file_size=n;break;case"multipart":n||(r.send_file_name=!0);break;case"resize":if(n)return a.extend({preserve_headers:!0,crop:!1},n);return!1;case"prevent_duplicates":r&&!r.filters&&(r.filters={}),r.filters.prevent_duplicates=!!n;break;case"unique_names":n&&(r.send_file_name=!0);break;case"container":case"browse_button":case"drop_element":return"container"===e?a.get(n):a.getAll(n)}return n}function u(e){return a.each(e,function(t,n){e[n]=o(n,t,e)}),e}var r=e.setTimeout,i={},a={VERSION:"2.1.2",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,OPTION_ERROR:-800,mimeTypes:t.mimes,ua:t.ua,typeOf:t.typeOf,extend:t.extend,guid:t.guid,getAll:function(t){var n=[],r;a.typeOf(t)!=="array"&&(t=[t]);var i=t.length;while(i--)r=a.get(t[i]),r&&n.push(r);return n.length?n:null},get:t.get,each:t.each,getPos:t.getPos,getSize:t.getSize,xmlEncode:function(e){var t={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},n=/[<>&\"\']/g;return e?(""+e).replace(n,function(e){return t[e]?"&"+t[e]+";":e}):e},toArray:t.toArray,inArray:t.inArray,addI18n:t.addI18n,translate:t.translate,sprintf:t.sprintf,isEmptyObj:t.isEmptyObj,hasClass:t.hasClass,addClass:t.addClass,removeClass:t.removeClass,getStyle:t.getStyle,addEvent:t.addEvent,removeEvent:t.removeEvent,removeAllEvents:t.removeAllEvents,cleanName:function(e){var t,n;n=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(t=0;t<n.length;t+=2)e=e.replace(n[t],n[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,""),e},buildUrl:function(e,t){var n="";return a.each(t,function(e,t){n+=(n?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),n&&(e+=(e.indexOf("?")>0?"&":"?")+n),e},formatSize:function(e){function t(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}if(e===n||/\D/.test(e))return a.translate("N/A");var r=Math.pow(1024,4);return e>r?t(e/r,1)+" "+a.translate("tb"):e>(r/=1024)?t(e/r,1)+" "+a.translate("gb"):e>(r/=1024)?t(e/r,1)+" "+a.translate("mb"):e>1024?Math.round(e/1024)+" "+a.translate("kb"):e+" "+a.translate("b")},parseSize:t.parseSizeStr,predictRuntime:function(e,n){var r,i;return r=new a.Uploader(e),i=t.Runtime.thatCan(r.getOption().required_features,n||e.runtimes),r.destroy(),i},addFileFilter:function(e,t){i[e]=t}};a.addFileFilter("mime_types",function(e,t,n){e.length&&!e.regexp.test(t.name)?(this.trigger("Error",{code:a.FILE_EXTENSION_ERROR,message:a.translate("File extension error."),file:t}),n(!1)):n(!0)}),a.addFileFilter("max_file_size",function(e,t,n){var r;e=a.parseSize(e),t.size!==r&&e&&t.size>e?(this.trigger("Error",{code:a.FILE_SIZE_ERROR,message:a.translate("File size error."),file:t}),n(!1)):n(!0)}),a.addFileFilter("prevent_duplicates",function(e,t,n){if(e){var r=this.files.length;while(r--)if(t.name===this.files[r].name&&t.size===this.files[r].size){this.trigger("Error",{code:a.FILE_DUPLICATE_ERROR,message:a.translate("Duplicate file error."),file:t}),n(!1);return}}n(!0)}),a.Uploader=function(e){function E(){var e=this,t;this.state==a.STARTED&&(d.length&&d.each(function(e,n){return d.remove(n),t=e,!1}),t||a.each(h,function(e){if(e.status==a.QUEUED)return t=e,!1}),t?e.uploadFile(t):p.length||(this.state!==a.STOPPED&&(this.state=a.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",h)))}function S(){var e,t;b.reset();for(e=0;e<h.length;e++)t=h[e],t.size!==n?(b.size+=t.origSize,b.loaded+=t.loaded*t.origSize/t.size):b.size=n,t.status==a.DONE?b.uploaded++:t.status==a.FAILED?b.failed++:b.queued++;b.size===n?b.percent=h.length>0?Math.ceil(b.uploaded/h.length*100):0:(b.bytesPerSec=Math.ceil(b.loaded/((+(new Date)-y||1)/1e3)),b.percent=b.size>0?Math.ceil(b.loaded/b.size*100):0)}function x(){var e=m[0]||g[0];return e?e.getRuntime().uid:!1}function T(){this.bind("FilesAdded FilesRemoved",function(e){e.trigger("QueueChanged"),e.refresh()}),this.bind("CancelUpload",O),this.bind("BeforeUpload",C),this.bind("UploadProgress",k),this.bind("StateChanged",A),this.bind("QueueChanged",S),this.bind("Error",M),this.bind("FileUploaded",L),this.bind("Destroy",_)}function N(e,n){var r=this,i=0,s=[],o={runtime_order:e.runtimes,required_caps:e.required_features,preferred_caps:v,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url};a.each(e.runtimes.split(/\s*,\s*/),function(t){e[t]&&(o[t]=e[t])}),e.browse_button&&a.each(e.browse_button,function(n){s.push(function(s){var u=new t.FileInput(a.extend({},o,{accept:e.filters.mime_types,name:e.file_data_name,multiple:e.multi_selection,container:e.container,browse_button:n}));u.onready=function(){var e=t.Runtime.getInfo(this.ruid);t.extend(r.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),multi_selection:e.can("select_multiple")}),i++,m.push(this),s()},u.onchange=function(){r.addFile(this.files)},u.bind("mouseenter mouseleave mousedown mouseup",function(r){w||(e.browse_button_hover&&("mouseenter"===r.type?t.addClass(n,e.browse_button_hover):"mouseleave"===r.type&&t.removeClass(n,e.browse_button_hover)),e.browse_button_active&&("mousedown"===r.type?t.addClass(n,e.browse_button_active):"mouseup"===r.type&&t.removeClass(n,e.browse_button_active)))}),u.bind("mousedown",function(){r.trigger("Browse")}),u.bind("error runtimeerror",function(){u=null,s()}),u.init()})}),e.drop_element&&a.each(e.drop_element,function(e){s.push(function(n){var s=new t.FileDrop(a.extend({},o,{drop_zone:e}));s.onready=function(){var e=t.Runtime.getInfo(this.ruid);t.extend(r.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),dragdrop:e.can("drag_and_drop")}),i++,g.push(this),n()},s.ondrop=function(){r.addFile(this.files)},s.bind("error runtimeerror",function(){s=null,n()}),s.init()})}),t.inSeries(s,function(){typeof n=="function"&&n(i)})}function C(e,t){if(e.settings.unique_names){var n=t.name.match(/\.([^.]+)$/),r="part";n&&(r=n[1]),t.target_name=t.id+"."+r}}function k(){S()}function L(e,t){p.remove(t.id),S(),r(function(){E.call(e)},1)}function A(e){if(e.state==a.STARTED)y=+(new Date);else if(e.state==a.STOPPED)for(var t=e.files.length-1;t>=0;t--)e.files[t].status==a.UPLOADING&&(e.files[t].status=a.QUEUED,S())}function O(){p.length&&p.each(function(e){e.cancelUpload()}),p.clear()}function M(e,t){t.code===a.INIT_ERROR?e.destroy():t.code===a.HTTP_ERROR&&(S(),e.state==a.STARTED&&(e.trigger("CancelUpload"),r(function(){E.call(e)},1)))}function _(e){e.stop(),a.each(h,function(e){e.destroy()}),h=[],m.length&&(a.each(m,function(e){e.destroy()}),m=[]),g.length&&(a.each(g,function(e){e.destroy()}),g=[]),p.clear(),d.clear(),v={},w=!1,y=null,b.reset()}var c=a.guid(),e,h=[],p=new l,d=new l,v={},m=[],g=[],y,b,w=!1;e=a.extend({runtimes:t.Runtime.order,multi_selection:!0,flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",filters:{mime_types:!1,prevent_duplicates:!1,max_file_size:0},max_upload_slots:1,multipart:!0,multipart_params:{},http_method:"POST",file_data_name:"file",chunk_size:0,send_file_name:!0,send_chunk_number:!0,max_retries:0,resize:!1},u(a.extend({},e))),e.required_features=s(a.extend({},e)),v=s(a.extend({},e,{required_features:!0})),b=new f,a.extend(this,{id:c,uid:c,state:a.STOPPED,features:{},runtime:null,files:h,settings:e,total:b,init:function(){var n=this,r,i,s;i=n.getOption("preinit"),typeof i=="function"?i(n):a.each(i,function(e,t){n.bind(t,e)}),T.call(n),a.each(["container","browse_button","drop_element"],function(e){if(n.getOption(e)===null)return s={code:a.INIT_ERROR,message:a.sprintf(a.translate("%s specified, but cannot be found."),e)},!1});if(s)return n.trigger("Error",s);if(!e.browse_button&&!e.drop_element)return n.trigger("Error",{code:a.INIT_ERROR,message:a.translate("You must specify either browse_button or drop_element.")});N.call(n,e,function(e){var r=n.getOption("init");typeof r=="function"?r(n):a.each(r,function(e,t){n.bind(t,e)});if(e){var i=t.Runtime.getInfo(x());n.trigger("Init",{ruid:i.uid,runtime:n.runtime=i.type}),n.trigger("PostInit")}else n.trigger("Error",{code:a.INIT_ERROR,message:a.translate("Init error.")})})},setOption:function(t,n){var r=this;if(typeof t=="object"){a.each(t,function(e,t){r.setOption(t,e)});return}var i=e[t];if(a.inArray(t,["container","browse_button","drop_element","runtimes","multi_selection","flash_swf_url","silverlight_xap_url"])!==-1){this.trigger("Error",{code:a.OPTION_ERROR,message:a.sprintf(a.translate("%s option cannot be changed.")),option:t});return}e[t]=o(t,n,e),r.trigger("OptionChanged",t,n,i)},getOption:function(t){return t?e[t]:e},refresh:function(){m.length&&a.each(m,function(e){e.trigger("Refresh")}),this.trigger("Refresh")},start:function(){this.state!=a.STARTED&&(this.state=a.STARTED,this.trigger("StateChanged"),E.call(this))},stop:function(){this.state!=a.STOPPED&&(this.state=a.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(){w=arguments[0]!==n?arguments[0]:!0,m.length&&a.each(m,function(e){e.disable(w)}),this.trigger("DisableBrowse",w)},uploadFile:function(e){var t=this,n=t.getOption("max_upload_slots");typeof e=="string"&&(e=this.getFile(e)),p.length<n?(t.trigger("BeforeUpload",e)&&(p.add(e.id,e),e.upload(t.getOption()),t.trigger("UploadFile",e)),p.length<n&&r(function(){E.call(t)})):d.add(e.id,e)},getFile:function(e){var t;for(t=h.length-1;t>=0;t--)if(h[t].id===e)return h[t]},addFile:function(e,n){function l(e){e.bind("progress",function(){s.trigger("UploadProgress",e)}),e.bind("uploaded",function(t,n){s.trigger("FileUploaded",e,n)}),e.bind("error",function(t,n){n.file=e,s.trigger("Error",n)})}function c(e,n){var r=[];t.each(s.settings.filters,function(t,n){i[n]&&r.push(function(r){i[n].call(s,t,e,function(e){r(!e)})})}),t.inSeries(r,n)}function p(e){var i=t.typeOf(e);if(e instanceof t.File){if(!e.ruid&&!e.isDetached()){if(!f)return!1;e.ruid=f,e.connectRuntime(f)}p(new a.File(e))}else e instanceof t.Blob?(p(e.getSource()),e.destroy()):e instanceof a.File?(n&&(e.name=n),o.push(function(t){c(e,function(n){n||(l(e),h.push(e),u.push(e),s.trigger("FileFiltered",e)),r(t,1)})})):t.inArray(i,["file","blob"])!==-1?p(new t.File(null,e)):i==="node"&&t.typeOf(e.files)==="filelist"?t.each(e.files,p):i==="array"&&(n=null,t.each(e,p))}var s=this,o=[],u=[],f;f=x(),p(e),o.length&&t.inSeries(o,function(){u.length&&s.trigger("FilesAdded",u)})},removeFile:function(e){var t=typeof e=="string"?e:e.id;for(var n=h.length-1;n>=0;n--)if(h[n].id===t)return this.splice(n,1)[0]},splice:function(e,t){var r=h.splice(e===n?0:e,t===n?h.length:t),i=!1;return this.state==a.STARTED&&(a.each(r,function(e){if(e.status===a.UPLOADING)return i=!0,!1}),i&&this.stop()),this.trigger("FilesRemoved",r),a.each(r,function(e){e.destroy()}),i&&this.start(),r},dispatchEvent:function(e){var t,n,r;e=e.toLowerCase(),t=this.hasEventListener(e);if(t){t.sort(function(e,t){return t.priority-e.priority}),n=[].slice.call(arguments),n.shift(),n.unshift(this);for(var i=0;i<t.length;i++)if(t[i].fn.apply(t[i].scope,n)===!1)return!1}return!0},bind:function(e,t,n,r){a.Uploader.prototype.bind.call(this,e,t,r,n)},destroy:function(){this.trigger("Destroy"),e=b=null,this.unbindAll()}})},a.Uploader.prototype=t.EventTarget.instance,a.File=function(){function i(i){function u(e,n){if(e.ruid){var r=t.Runtime.getInfo(e.ruid);if(r)return r.can(n)}return!1}function f(e,r,i){var s=new t.Image;try{s.onload=function(){if(r.width>this.width&&r.height>this.height&&r.quality===n&&r.preserve_headers&&!r.crop)return this.destroy(),i(e);var t=r.width;r.width>this.width&&(t=this.width);var o=r.height;r.height>this.height&&(o=this.height),s.downsize(t,o,r.crop,r.preserve_headers)},s.onresize=function(){i(this.getAsBlob(e.type,r.quality)),this.destroy()},s.onerror=function(){i(e)},s.load(e)}catch(o){i(e)}}var s=a.guid(),o;a.extend(this,{id:s,uid:s,name:i.name||i.fileName,type:i.type||"",size:i.size||i.fileSize,origSize:i.size||i.fileSize,loaded:0,percent:0,status:a.QUEUED,lastModifiedDate:i.lastModifiedDate||(new Date).toLocaleString(),isImage:function(){return t.inArray(this.type,["image/jpeg","image/png"])!==-1},getNative:function(){var e=this.getSource().getSource();return t.inArray(t.typeOf(e),["blob","file"])!==-1?e:null},getSource:function(){return e[this.id]?e[this.id]:null},upload:function(e){function d(){h-->0?r(v,1e3):(n.loaded=p,n.status=a.FAILED,n.trigger("Error",{code:a.HTTP_ERROR,message:a.translate("HTTP Error."),response:o.responseText,status:o.status,responseHeaders:o.getAllResponseHeaders()}))}function v(){var u,f,m=e.url,g={},y;e.send_file_name&&(g.name=n.target_name||n.name),c&&s&&i.size>c?(y=Math.min(c,i.size-p),u=i.slice(p,p+y)):(y=i.size,u=i),c&&s&&(e.send_chunk_number?(g.chunk=Math.ceil(p/c),g.chunks=Math.ceil(i.size/c)):(g.offset=p,g.total=i.size)),o=new t.XMLHttpRequest,o.upload&&(o.upload.onprogress=function(e){n.loaded=Math.min(n.size,p+e.loaded),n.size&&(n.percent=Math.ceil(n.loaded/n.size*100)),n.trigger(e)}),o.onload=function(){if(o.status>=400){d();return}h=e.max_retries,y<i.size?(u.destroy(),p+=y,n.loaded=Math.min(p,i.size),n.percent=Math.ceil(n.loaded/n.size*100),n.trigger("ChunkUploaded",{offset:n.loaded,total:i.size,response:o.responseText,status:o.status,responseHeaders:o.getAllResponseHeaders()}),t.Env.browser==="Android Browser"&&n.trigger({type:"Progress",loaded:n.loaded,total:i.size})):n.loaded=n.size,u=f=null,!p||p>=i.size?(n.size!=n.origSize&&(i.destroy(),i=null),n.percent=100,n.trigger({type:"Progress",loaded:n.loaded,total:n.size}),n.status=a.DONE,n.trigger("Uploaded",{response:o.responseText,status:o.status,responseHeaders:o.getAllResponseHeaders()})):r(v,1)},o.onerror=function(){d()},o.onloadend=function(){this.destroy(),o=null},e.multipart&&l?(o.open(e.http_method,m,!0),a.each(e.headers,function(e,t){o.setRequestHeader(t,e)}),f=new t.FormData,a.each(a.extend(g,e.multipart_params),function(e,t){f.append(t,e)}),f.append(e.file_data_name,u),o.send(f)):(m=a.buildUrl(e.url,a.extend(g,e.multipart_params)),o.open(e.http_method,m,!0),(a.isEmptyObj(e.headers)||!e.headers["content-type"])&&o.setRequestHeader("content-type","application/octet-stream"),a.each(e.headers,function(e,t){o.setRequestHeader(t,e)}),o.send(u))}e=a.extend({multipart:!0,multipart_params:{},http_method:"POST",headers:{},file_data_name:"file",chunk_size:0,send_file_name:!0,send_chunk_number:!0,max_retries:0,resize:!1},e);var n=this,i=n.getSource(),s=u(i,"slice_blob"),l=u(i,"send_multipart"),c=e.chunk_size,h=e.max_retries,p=0;n.status=a.UPLOADING,n.loaded&&(p=n.loaded=c*Math.floor(n.loaded/c)),!a.isEmptyObj(e.resize)&&n.isImage()&&u(i,"send_binary_string")?f.call(this,i,e.resize,function(e){i=e,n.size=e.size,v()}):v()},cancelUpload:function(){o&&(o.abort(),o.destroy(),o=null)},destroy:function(){this.cancelUpload(),this.unbindAll();var t=this.getSource();t&&(t.destroy(),delete e[this.id])}}),e[this.id]=i}var e={};return i.prototype=t.EventTarget.instance,i}();var f=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},l=function(){var e={};this.length=0,this.get=function(t){return e.hasOwnProperty(t)?e[t]:null},this.add=function(t,n){if(e.hasOwnProperty(t))return this.update.apply(this,arguments);e[t]=n,this.length++},this.remove=function(t){e.hasOwnProperty(t)&&(delete e[t],this.length--)},this.update=function(t,n){e[t]=n},this.each=function(t){a.each(e,t)},this.clear=function(){e={},this.length=0}};e.plupload=a})(window,mOxie);